# Exercise Browser Routing & Variation Grouping

This file is auto-generated by Windsurf and might become handy if we need to dig into the code again

## Overview

The exercise browser implements routable exercise details with variation grouping while maintaining the original integrated layout design. Exercise details appear as side panels (desktop) or modal dialogs (mobile/tablet) within the ExercisesScreen rather than as separate pages.

## URL Structure

### Base Routes
- `/exercises` - Exercise browser with filters and list
- `/exercises/{exercise-id}` - Exercise browser with specific exercise selected
- `/exercises/{exercise-id}?mod_{key}={value}` - Exercise with modifier options

### URL Encoding Rules
Following character restrictions in `exercises.dart`:
- **Allowed**: `a-z`, `0-9`, `°`, `-`, `space`, `()`, `>`
- **Prohibited**: `&` (ugly URL encoding), `_` (reserved for space encoding)
- **Space Encoding**: Spaces → underscores in URLs to avoid `%20`

### Examples
```
/exercises/standing_barbell_squat
/exercises/standing_barbell_squat?mod_stance=wide&mod_grip=overhand
```

## Architecture

### Layout Behavior
- **Desktop (>1024px)**: 3-panel layout with exercise details in 400px side panel
- **Tablet (768-1024px)**: Modal dialog overlay for exercise details
- **Mobile (<768px)**: Modal dialog overlay for exercise details

### State Management
- Exercise selection managed via `exerciseFilterProvider` (Riverpod)
- URL synchronization using `ref.listen` for state changes
- Modal dialogs triggered by state changes, not direct user actions

### Navigation Flow
1. User clicks exercise → Updates selection state
2. State change triggers URL update via `ref.listen`
3. On mobile/tablet: State change triggers modal dialog
4. On desktop: Side panel shows/hides based on selection state

## Exercise Variation Grouping

### Display Logic
- Base exercises show with expand/collapse functionality
- Variation count badges indicate total variations available
- Modifier options displayed as chips for each variation
- Clicking variations selects base exercise with specific modifier options

### Variation Generation
Uses `_generateExerciseVariations()` to create all possible combinations of exercise modifiers for display purposes (not actual workout parameters).

## URL Utility Functions

Located in `/lib/util/url.dart`:

### Core Functions
- `buildExerciseDetailUrl(exerciseId, modifierOptions)` - Builds encoded URLs
- `parseExerciseParams(queryParameters)` - Parses modifier options from URLs
- `parseExerciseId(pathId)` - Decodes exercise ID from URL path

### Encoding/Decoding
- **Encoding**: Spaces → underscores before URL construction
- **Decoding**: Underscores → spaces after URL parsing
- **Modifier Prefix**: `mod_` prefix added/stripped during URL processing

## Routing Implementation

### Main.dart Route Configuration
```dart
GoRoute(
  name: ExercisesScreen.routeName,
  path: ExercisesScreen.routeName,  // "exercises"
  builder: (context, state) => const ExercisesScreen(),
  routes: [
    GoRoute(
      path: '/:id',
      builder: (context, state) {
        final id = state.pathParameters['id']!;
        return ExercisesScreen(
          exerciseId: parseExerciseId(id),
          modifierOptions: parseExerciseParams(state.uri.queryParameters)
        );
      },
    ),
  ],
)
```

### ExercisesScreen URL Initialization
- URL parameters parsed in `initState()` using `addPostFrameCallback`
- Delay prevents Riverpod "provider modification during build" error
- Exercise selection state initialized from URL parameters

## Key Design Decisions

### Integrated Layout Over Separate Pages
- **Rationale**: Maintains original UX where details appear within the exercise browser
- **Implementation**: ExercisesScreen handles both list and detail views
- **Benefit**: Consistent navigation experience across screen sizes

### State-Based Modal Triggers
- **Pattern**: `ref.listen` for side effects instead of `Consumer` rebuilds
- **Benefit**: Cleaner separation between UI building and side effects
- **Performance**: Avoids unnecessary widget rebuilds

### URL Encoding Strategy
- **Choice**: Underscores instead of percent encoding for spaces
- **Rationale**: Cleaner URLs, follows existing character restrictions
- **Implementation**: Centralized in utility functions for consistency

### Riverpod Error Handling
- **Issue**: Provider modification during widget lifecycle
- **Solution**: `addPostFrameCallback` delays state updates until after build
- **Pattern**: Standard approach for initializing provider state from external sources

## File Structure

### Core Files
- `/lib/ui/exercises/page/exercises_screen.dart` - Main screen with integrated layout
- `/lib/ui/exercises/widget/exercise_list.dart` - Exercise list with variation grouping
- `/lib/util/url.dart` - URL encoding/decoding utilities
- `/lib/main.dart` - Route configuration

### State Management
- `/lib/data/exercises/exercise_filter_provider.dart` - Exercise selection state
- Uses Riverpod for reactive state management and URL synchronization
